openapi: 3.0.0
info:
  title: Voucher & Promotion System API
  version: 1.0.0
  description: |
    API documentation for Vouchers, Promotions, Apply logic, and Orders.

    Key Behaviors:
    - Voucher/Promotion identified by **code** (string)
    - Orders identified by **MongoDB ObjectId**
    - Apply Endpoint supports:
      1) items only
      2) orderId only
      3) both items + orderId

servers:
  - url: http://localhost:5000
    description: Local Development
  - url: https://voucher-system-backend-javm.onrender.com
    description: Production (Render)

tags:
  - name: Voucher
  - name: Promotion
  - name: Apply
  - name: Orders

paths:

  ######################################
  # VOUCHERS
  ######################################
  /api/v1/vouchers:
    post:
      tags: [Voucher]
      summary: Create a new voucher
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VoucherCreate"
      responses:
        201:
          description: Voucher created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Voucher"
        400:
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        409:
          description: Duplicate voucher code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                message: "Code already exists"

    get:
      tags: [Voucher]
      summary: List all vouchers
      responses:
        200:
          description: List of vouchers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Voucher"

  /api/v1/vouchers/{code}:
    get:
      tags: [Voucher]
      summary: Get voucher by code
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
      responses:
        200:
          description: Voucher details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Voucher"
        404:
          description: Voucher not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                message: "Voucher not found"

    put:
      tags: [Voucher]
      summary: Update voucher by code
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VoucherUpdate"
      responses:
        200:
          description: Voucher updated
        404:
          description: Voucher not found

    delete:
      tags: [Voucher]
      summary: Soft delete voucher by code
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
      responses:
        200:
          description: Voucher deactivated (isActive = false)

  ######################################
  # PROMOTIONS
  ######################################
  /api/v1/promotions:
    post:
      tags: [Promotion]
      summary: Create a promotion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PromotionCreate"
      responses:
        201:
          description: Promotion created
    get:
      tags: [Promotion]
      summary: List all promotions
      responses:
        200:
          description: List of promotions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Promotion"

  /api/v1/promotions/{code}:
    get:
      tags: [Promotion]
      summary: Get promotion by code
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
      responses:
        200:
          description: Promotion details

    put:
      tags: [Promotion]
      summary: Update promotion
      parameters:
        - in: path
          name: code
          schema:
            type: string
          required: true
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PromotionUpdate"
      responses:
        200:
          description: Promotion updated

    delete:
      tags: [Promotion]
      summary: Soft delete promotion
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
      responses:
        200:
          description: Promotion deactivated

  ######################################
  # APPLY
  ######################################
  /api/v1/apply:
    post:
      tags: [Apply]
      summary: Apply voucher or promotion
      description: |
        Apply a voucher/promotion to an order or list of items.

        Supported:
        - items only
        - orderId only
        - both items + orderId

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApplyRequest"
            examples:
              items-only:
                summary: Apply using items
                value:
                  code: "SAVE10"
                  items:
                    - productId: "101"
                      categoryId: "A"
                      quantity: 2
                      unitPrice: 100

              order-only:
                summary: Apply on existing orderId
                value:
                  code: "SAVE10"
                  orderId: "6922d2bc7d88a9e51510d402"

      responses:
        200:
          description: Discount applied successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplyResponse"

        400:
          description: Validation error OR invalid orderId
          content:
            application/json:
              examples:
                InvalidId:
                  value:
                    status: "error"
                    message: "Invalid ID format"
                ZodValidationFailed:
                  value:
                    status: "error"
                    errors:
                      - field: "items.0.quantity"
                        message: "quantity must be greater than 0"

        404:
          description: Code not found/inactive
          content:
            application/json:
              example:
                status: "error"
                message: "Code not found or inactive"

        409:
          description: Code already applied / duplicate
          content:
            application/json:
              examples:
                AlreadyApplied:
                  value:
                    status: "error"
                    message: "Code already applied to this order"
                Duplicate:
                  value:
                    status: "error"
                    message: "Code already exists"

        422:
          description: Business rule violation
          content:
            application/json:
              examples:
                Expired:
                  value:
                    status: "error"
                    message: "Code expired"
                UsageLimit:
                  value:
                    status: "error"
                    message: "Usage limit exceeded"
                MinOrder:
                  value:
                    status: "error"
                    message: "Minimum order value not met"
                IneligibleProduct:
                  value:
                    status: "error"
                    message: "Code not applicable to any products"
                IneligibleCategory:
                  value:
                    status: "error"
                    message: "Code not applicable to any categories"

  ######################################
  # ORDERS
  ######################################
  /api/v1/orders:
    post:
      tags: [Orders]
      summary: Create an order
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderCreate"
      responses:
        201:
          description: Order created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"

        400:
          description: Zod validation failure

    get:
      tags: [Orders]
      summary: List all orders
      responses:
        200:
          description: List of orders

  /api/v1/orders/{id}:
    get:
      tags: [Orders]
      summary: Get order by ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        200:
          description: Order details
        400:
          description: Invalid ObjectId
          content:
            application/json:
              example:
                status: "error"
                message: "Invalid ID format"
        404:
          description: Order not found

######################################
# COMPONENTS (SCHEMAS)
######################################
components:
  schemas:

    ################################
    # ERROR RESPONSES
    ################################
    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: "error"
        message:
          type: string

    ValidationErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: "error"
        errors:
          type: array
          items:
            type: object
            properties:
              field: { type: string }
              message: { type: string }

    ################################
    # VOUCHER SCHEMAS
    ################################
    Voucher:
      type: object
      properties:
        code: { type: string }
        discountType:
          type: string
          enum: [percentage, fixed]
        discountValue: { type: number }
        maxDiscountAmount: { type: number }
        expiresAt: { type: string, format: date }
        totalUsesAllowed: { type: number }
        usesCount: { type: number }
        minOrderValue: { type: number }
        isActive: { type: boolean }

    VoucherCreate:
      type: object
      required: [discountType, discountValue, expiresAt]
      properties:
        discountType:
          type: string
          enum: [percentage, fixed]
        discountValue: { type: number }
        expiresAt: { type: string }
        maxDiscountAmount: { type: number }
        totalUsesAllowed: { type: number }
        minOrderValue: { type: number }
        metadata:
          type: object

    VoucherUpdate:
      type: object
      properties:
        discountValue: { type: number }
        expiresAt: { type: string }
        maxDiscountAmount: { type: number }
        isActive: { type: boolean }

    ################################
    # PROMOTION SCHEMAS
    ################################
    Promotion:
      type: object
      properties:
        code: { type: string }
        discountType:
          type: string
          enum: [percentage, fixed]
        discountValue: { type: number }
        expiresAt: { type: string }
        eligibleProductIds:
          type: array
          items: { type: string }
        eligibleCategoryIds:
          type: array
          items: { type: string }

    PromotionCreate:
      type: object
      required: [discountType, discountValue, expiresAt]
      properties:
        discountType:
          type: string
          enum: [percentage, fixed]
        discountValue: { type: number }
        expiresAt: { type: string }
        eligibleProductIds:
          type: array
          items: { type: string }
        eligibleCategoryIds:
          type: array
          items: { type: string }

    PromotionUpdate:
      type: object
      properties:
        discountValue: { type: number }
        expiresAt: { type: string }
        isActive: { type: boolean }

    ################################
    # APPLY SCHEMAS
    ################################
    ApplyRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
        orderId:
          type: string
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"

    ApplyResponse:
      type: object
      properties:
        type: { type: string }
        code: { type: string }
        subtotal: { type: number }
        discount: { type: number }
        total: { type: number }

    ################################
    # ORDER SCHEMAS
    ################################
    OrderItem:
      type: object
      properties:
        productId: { type: string }
        categoryId: { type: string }
        quantity: { type: number }
        unitPrice: { type: number }

    OrderCreate:
      type: object
      required: [userId, items]
      properties:
        userId: { type: string }
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"
        code:
          type: string

    OrderResponse:
      type: object
      properties:
        _id: { type: string }
        userId: { type: string }
        items:
          type: array
          items: { $ref: "#/components/schemas/OrderItem" }
        subtotal: { type: number }
        appliedCodes:
          type: array
          items:
            type: object
            properties:
              type: { type: string }
              code: { type: string }
              appliedAmount: { type: number }
              voucherId: { type: string }
              promotionId: { type: string }
        total: { type: number }
        createdAt: { type: string }
        updatedAt: { type: string }
